"use strict";var Picotable=function(e,t){function n(t){for(var n=0,r=1;r<t.length;r++)if(t[r]._page!==t[r-1]._page+1){var i=e("li",{key:"dummy"+n++,className:"disabled"},e("a",{href:"#"},"â‹¯"));t.splice(r,0,i),r++}}function r(t,r){if(0===t.nItems)return e("nav");for(var i=e.withAttr("rel",r),a=t.pageNum,l=[],o=function(t,n){return e("a",{rel:t,href:"#",onclick:i},n||t)},s=1;s<=t.nPages;s++)if(1===s||s===t.nPages||Math.abs(s-a)<=2){var c=e("li",{key:s,className:S({active:a===s})},o(s));c._page=s,l.push(c)}n(l);var u=e("li",{key:"previous",className:S({disabled:1===a})},o(a-1,gettext("Previous"))),d=e("li",{key:"next",className:S({disabled:a===t.nPages})},o(a+1,gettext("Next")));return e("nav",e("ul.pagination",u,l,d))}function i(e){return function(t,n,r){n||(t.oninput=r.debouncedOnInput=k.debounce(t.onchange,e))}}function a(t,n,r){var i=function(){var e=JSON.parse(this.value);t.setFilterValue(n.id,e)},a=function(){return function(e,t){t||$(e).select2()}},l=e("select.form-control",{config:n.filter.select2?a():null,value:JSON.stringify(r),onchange:i},k.map(n.filter.choices,function(t){return e("option",{value:JSON.stringify(t[0]),key:t[0]},t[1])}));return e("div.choice-filter",l)}function l(e){for(var t=e.vm.data(),n={},r=0;r<t.columns.length;r++)if(t.columns[r].filter){var i=t.columns[r].filter.defaultChoice;i&&(n[t.columns[r].id]=i)}return n}function o(t,n,r){var a=function(e){var r=k.extend({},t.getFilterValue(n.id)||{}),i=this.value;k.trim(i)||(i=null),r[e]=i,t.setFilterValue(n.id,r)},l={type:n.filter.range.type||"text"},o=!1;"date"==l.type&&(o=!0,l.type="text"),k.map(["min","max","step"],function(e){var t=n.filter.range[e];void 0!==t&&null!==t&&(l[e]=t,l.type="number")}),r=r||{};var s=e("input.form-control",k.extend({},l,{value:k.stringValue(r.min),placeholder:w.RANGE_FROM,onchange:function(){a.call(this,"min")},config:o?t.datePicker():i(500)})),c=e("input.form-control",k.extend({},l,{value:k.stringValue(r.max),placeholder:w.RANGE_TO,onchange:function(){a.call(this,"max")},config:o?t.datePicker():i(500)}));return e("div.range-filter",[e("div.input-wrapper.min",{key:"min"},s),e("div.input-wrapper.max",{key:"max"},c)])}function s(t,n,r){var a=function(){t.setFilterValue(n.id,this.value)},l=e("input.form-control",{type:n.filter.text.type||"text",value:k.stringValue(r),placeholder:n.filter.placeholder||interpolate(gettext("Filter by %s"),[n.title]),onchange:a,config:i(500)});return e("div.text-filter",l)}function c(e,t){var n=e.getFilterValue(t.id);return t.filter.choices?a(e,t,n):t.filter.range?o(e,t,n):t.filter.text?s(e,t,n):void 0}function u(t,n,r){var i=null,a={"":n.className},l=null;if(n.sortable){var o=t.vm.sort(),s=null;o==="+"+n.id&&(s="asc"),o==="-"+n.id&&(s="desc");var c="fa-sort"+(s?"-"+s:"");i=e("i.fa."+c),a.sortable=!0,s&&(a["sorted-"+s]=!0),l=function(){t.setSortColumn(n.id)}}var u={key:n.id,className:S(a),onclick:l},d=t.vm.data()?t.vm.data().massActions:null;return d.length&&(0==r&&(u.className+=" hidden"),1==r&&(u.colspan=2)),e("th",u,[i," ",n.title])}function d(t,n,r){var i=null;n.filter&&(i=c(t,n));var a={key:n.id,className:n.className||""},l=t.vm.data()?t.vm.data().massActions:null;return l.length&&(0==r&&(a.className+=" hidden"),1==r&&(a.colspan=2)),e("th",a,[i])}function m(t){var n=t.vm.data();if(null!==n){var i=k.extend(l(t),t.vm.filterValues());t.vm.filterValues(i);var a=k.map(n.columns,function(e,n){return u(t,e,n)}),o=k.any(n.columns,k.property("filter"))?k.map(n.columns,function(e,n){return d(t,e,n)}):null,s=e("thead",[e("tr.headers",a),o?e("tr.filters",o):null]),c=n.columns.length,m=e("td",{colspan:c},r(n.pagination,t.setPage)),v=e("tfoot",[e("tr",m)]),p=t.vm.data()?t.vm.data().massActions:null,g=!!t.vm.pickId(),h=k.map(n.items,function(r,i){var a={key:"item-"+r._id};return p.length&&(a.onclick=function(){t.saveCheck(r)},a["class"]=t.isChecked(r)?"active":""),e("tr",a,k.map(n.columns,function(n,i){if(0==i&&p.length)var a=e("input[type=checkbox]",{value:r.type+"-"+r._id,"class":"row-selection",onclick:k.boundPartial(t,t.saveCheck,r),checked:t.isChecked(r)});else var a=r[n.id]||"";return n.raw&&(a=e.trust(a)),n.linked&&(g?a=e("a",{href:"#",onclick:k.boundPartial(t,t.pickObject,r)},a):r._url&&(a=e("a",{href:r._url,onclick:f},a))),e("td",{key:"col-"+n.id,className:n.className||""},[a])}))}),b=e("tbody",h),y=p.length?".has-mass-actions":"";return e("table.table.table-striped.picotable-table"+y,[s,v,b])}}function f(e){e.stopPropagation()}function v(t){var n=t.vm.data(),r=k.map(n.columns,function(n){return n.filter?e("div.single-filter",e("h3",n.title),c(t,n)):null});return e("div.mobile-filters.shuup-modal-bg",{key:"mobileFilterModal"},[e("div.shuup-modal-container",[e("div.shuup-modal-header",[e("h2.pull-left",[e("i.fa.fa-filter")],gettext("Filters")),e("button.btn.btn-success.pull-right",{onclick:function(){t.vm.showMobileFilterSettings(!1)}},"Done"),e("button.btn.btn-gray.btn-inverse.pull-right",{onclick:t.resetFilters,disabled:k.isEmpty(t.vm.filterValues())},w.RESET)]),e("div.mobile-filters-content",r)])])}function p(t){var n=t.vm.data(),r=[];return k.map(n.columns,function(e){e.sortable&&(r.push({value:"+"+e.id,text:""+w.SORT_BY+" "+e.title+" "+w.SORT_ASC}),r.push({value:"-"+e.id,text:""+w.SORT_BY+" "+e.title+" "+w.SORT_DESC}))}),r.length?(r.unshift({value:"",text:w.SORT_DEFAULT}),e("select.picotable-mobile-sort.form-control",{id:"mobile-sort-select",value:t.vm.sort()||"",onchange:e.withAttr("value",function(e){t.setSortColumn(e),t.refresh()})},k.map(r,function(t){return e("option",{value:t.value},t.text)}))):void 0}function g(t){var n=t.vm.data();if(null!==n){var i=k.extend(l(t),t.vm.filterValues());t.vm.filterValues(i);var a=!!t.vm.pickId(),o=k.map(n.items,function(r){var i=null;r._abstract&&r._abstract.length&&(i=k.map(r._abstract,function(t){if(t&&("string"==typeof t&&(t={text:t}),t.text)){t.raw&&(t.text=e.trust(t.raw));var n="div.inner-row."+(t.title?"with-title":"")+(t["class"]?"."+t["class"]:"");return e(n,[t.title?e("div.column.title",t.title):null,e("div.column",t.text)])}}),k.any(i,function(e){return!!e})||(i=null)),null===i&&(i=k.map(n.columns,function(t){var n=r[t.id]||"";return t.raw&&(n=e.trust(n)),e("div.inner-row.with-title",[e("div.column.title",t.title),e("div.column",n)])}));var l={href:r._url};a&&(l.onclick=k.boundPartial(t,t.pickObject,r),l.href="#");var o=r._linked_in_mobile?e("a.inner",l,i):e("span.inner",i);return e("div.list-element",o)});return e("div.mobile",[e("div.row.mobile-header",[e("div.col-sm-6",[e("button.btn.btn-info.btn-block.toggle-btn",{onclick:function(){t.vm.showMobileFilterSettings(!0)}},[e("i.fa.fa-filter")],"Show filters")]),e("div.col-sm-6",[e("div.mobile-sort",p(t))])]),t.vm.showMobileFilterSettings()?v(t):null,e("hr"),e("div.mobile-items",o),r(n.pagination,t.setPage)])}}function h(t){var n=t.vm.data()?t.vm.data().massActions:null;if(null==n)return"";var r=function(){return function(e,t){t||$(e).select2()}},i=t.vm.data().items.length,a=[{key:0,value:gettext("Select Action")},{key:"unselect_all",value:gettext("Clear Selections")},{key:"select_listed",value:gettext("Select All")},{key:"select_all",value:interpolate(gettext("Select All %s Items"),[i])}];return n=a.concat(n),e("div.picotable-mass-actions",[t.vm.allItemsSelected()?e("p",interpolate(gettext("All %s Items Selected"),[i])):null,e("select.picotable-mass-action-select.form-control",{id:"mass-action-select"+t.id,config:r(),value:0,onchange:e.withAttr("value",function(e){t.doMassAction(e)})},k.map(n,function(t){return e("option",{value:t.key,"data-redirects":t.redirects,"data-redirect-url":t.redirect_url},t.value)}))])}function b(t){var n=t.vm.data()?t.vm.data().itemInfo:null;return e("div.picotable-header",[h(t),e("div.picotable-items-per-page-ctr",[e("label",{"for":"pipps"+t.id},w.ITEMS_PER_PAGE),e("select.picotable-items-per-page-select.form-control",{id:"pipps"+t.id,value:t.vm.perPage(),onchange:e.withAttr("value",function(e){t.vm.perPage(e),t.refresh()})},k.map(t.vm.perPageChoices(),function(t){return e("option",{value:t},t)}))]),e("div.picotable-item-info",n),e("div.picotable-reset-filters-ctr",e("button.picotable-reset-filters-btn.btn.btn-gray.btn-inverse",{onclick:t.resetFilters,disabled:k.isEmpty(t.vm.filterValues())},w.RESET_FILTERS))])}function y(t){return e("div.table-view",[t.vm.showHeader()?b(t):null,"mobile"===t.vm.renderMode()?g(t):m(t)])}function x(){var n=this;n.id="0"|134217727*Math.random(),n.vm={url:e.prop(null),sort:e.prop(null),filterEnabled:e.prop({}),filterValues:e.prop({}),checkboxes:e.prop([]),allItemsSelected:e.prop(!1),page:e.prop(1),perPage:e.prop(20),perPageChoices:e.prop([20,50,100,200]),showHeader:e.prop(!0),data:e.prop(null),renderMode:e.prop("normal"),showMobileFilterSettings:e.prop(!1),pickId:e.prop(null)},n.setRenderMode=function(e){var t=n.vm.renderMode();n.vm.renderMode(e),e!==t&&n.refresh()},n.adaptRenderMode=function(){var e=window.innerWidth;n.setRenderMode(992>e?"mobile":"normal")},n.setSource=function(e){n.vm.url(e),n.refresh()},n.setSortColumn=function(e){var t=null;if(e&&e.length&&"null"!==e)if(/^[+-]/.test(e))t=e;else{var r=n.vm.sort();t=r==="+"+e?"-"+e:r==="-"+e?null:"+"+e}n.vm.sort(t),n.refresh()},n.getFilterValue=function(e){return n.vm.filterValues()[e]},n.setFilterValue=function(e,t){var r=n.vm.filterValues();"string"==typeof t&&""===k.trim(t)&&(t=null),r[e]=t,r=k.omitNulls(r),n.vm.filterValues(r),n.refresh()},n.resetFilters=function(){n.vm.filterValues({}),n.refresh()},n.resetCheckboxes=function(){n.vm.allItemsSelected(!1),n.vm.checkboxes([])},n.saveCheck=function(e){var t=n.vm.checkboxes(),r=t.filter(function(t){return t!==e._id});r.length<t.length?n.vm.checkboxes(r):(t.push(e._id),n.vm.checkboxes(t)),$(e).toggleClass("active")},n.isChecked=function(e){var t=n.vm.checkboxes(),r=t.filter(function(t){return t===e._id});return r.length>0},n.getMassActionResponse=function(e){if(200===e.status){var t="",r=e.getResponseHeader("Content-Disposition");if(r&&-1!==r.indexOf("attachment")){var i=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/,a=i.exec(r);null!=a&&a[1]&&(t=a[1].replace(/['"]/g,""))}var l=e.getResponseHeader("Content-Type"),o=new Blob([e.response],{type:l});if("undefined"!=typeof window.navigator.msSaveBlob)window.navigator.msSaveBlob(o,t);else{var s=window.URL||window.webkitURL,c=s.createObjectURL(o);if(t){var u=document.createElement("a");"undefined"==typeof u.download?window.location=c:(u.href=c,u.download=t,document.body.appendChild(u),u.click())}else{var d=$("option[value="+window.savedValue+"]").data("redirects");d&&(window.location=$("option[value="+window.savedValue+"]").data("redirect-url")),n.resetCheckboxes(),$(".picotable-mass-action-select").val(0),n.refresh(),setTimeout(function(){window.Messages.enqueue({tags:"success",text:gettext("Mass Action complete.")})},1e3)}setTimeout(function(){s.revokeObjectURL(c)},100)}}},n.doMassAction=function(t){switch(t){case"select_all":return void n.selectAllProducts();case"select_listed":return void n.selectAllListedProducts();case"unselect_all":return void n.resetCheckboxes()}var r=n.vm.checkboxes();if(window.savedValue=t,0==r.length)return void alert(gettext("You haven't selected anything"));if(0!=t){if(!confirm(gettext("Confirm action by clicking OK!")))return $(".picotable-mass-action-select").val(0),void n.refresh();var i=function(e){e.setRequestHeader("X-CSRFToken",window.ShuupAdminConfig.csrf),e.setRequestHeader("Content-type","application/json"),e.responseType="blob"},a={action:t,values:n.vm.allItemsSelected()?"all":r};e.request({method:"POST",url:window.location.pathname,data:a,extract:n.getMassActionResponse,config:i})}},n.selectAllListedProducts=function(){n.vm.allItemsSelected(!1),n.vm.checkboxes(n.vm.data().items.map(function(e){return e._id}))},n.selectAllProducts=function(){n.selectAllListedProducts(),n.vm.allItemsSelected(!0)},n.setPage=function(e){e=0|e,(isNaN(e)||1>e)&&(e=1),n.vm.page(e),n.refresh()},n.refresh=function(){var t=n.vm.url();if(t){var r={sort:n.vm.sort(),perPage:0|n.vm.perPage(),page:0|n.vm.page(),filters:n.vm.filterValues()},i=e.route.parseQueryString(decodeURI(location.search));i.jq=JSON.stringify(r),e.request({method:"GET",url:t,data:i}).then(n.vm.data,function(){alert("An error occurred.")}),n.saveSettings()}},n.saveSettings=function(){t&&t.setItem("picotablePerPage",n.vm.perPage())},n.loadSettings=function(){if(t){var e=0|t.getItem("picotablePerPage");e>1&&n.vm.perPage(e);var r=/pick=([^&]+)/.exec(location.search);n.vm.pickId(r?r[1]:null)}},n.pickObject=function(e){var t=window.opener;if(!t)return void alert("Window has no opener. Can't pick object.");var r=null;k.map(["_text","_name","title","name","text"],function(t){!r&&e[t]&&(r=e[t])}),!r&&e._abstract&&e._abstract.length>0&&(r=e._abstract[0],r.text&&(r=r.text)),r||(r="#"+e._id),t.postMessage({pick:{id:n.vm.pickId(),object:{id:e._id,text:r,url:e._url}}},"*"),event.preventDefault()},n.datePicker=function(){return function(e,t){t||$(e).datetimepicker({format:"yyyy-mm-dd",autoclose:!0,todayBtn:!0,todayHighlight:!0,fontAwesome:!0,minView:2})}},n.loadSettings(),n.adaptRenderMode(),window.addEventListener("resize",k.debounce(n.adaptRenderMode,100)),e.deferred.onerror=function(e){if(!e.toString().match(/^SyntaxError/)&&"[object Error]"==={}.toString.call(e)&&!e.constructor.toString().match(/ Error/))throw e}}e=e||require("mithril");var k=function(){function t(e){return function(t){return t[e]}}function n(e,t){return Array.isArray(e)?e.map(t):Object.keys(e).map(function(n){return t(e[n],n,e)})}function r(e,t){return Array.isArray(e)?e.some(t):Object.keys(e).some(function(n){return t(e[n],n,e)})}function i(){for(var e=arguments[0],t=1;t<arguments.length;t++)for(var n in arguments[t])arguments[t].hasOwnProperty(n)&&(e[n]=arguments[t][n]);return e}function a(e){return(""+e).replace(/^\s+|\s+$/g,"")}function l(e){var t={};return n(e,function(e,n){null!==e&&(t[n]=e)}),t}function o(t,n){function r(){return l=this,o=arguments,s=(new Date).getTime(),c||(e.startComputation(),c=setTimeout(i,n),a&&(u=t.apply(l,o),l=o=null)),u}function i(){var r=(new Date).getTime()-s;n>r&&r>0?c=setTimeout(i,n-r):(c=null,a||(u=t.apply(l,o),l=o=null),e.endComputation())}var a=arguments.length<=2||void 0===arguments[2]?!1:arguments[2],l=void 0,o=void 0,s=void 0,c=void 0,u=void 0;return r}function s(e){return null===e||void 0===e?"":Array.isArray(e)&&0===e.length?"":""+e}function c(e){if(e.length)return!1;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function u(e,t){var n=[].slice.call(arguments,2);return function(){var r=n.concat([].slice.call(arguments));return t.apply(e,r)}}return{property:t,map:n,any:r,extend:i,trim:a,omitNulls:l,debounce:o,stringValue:s,isEmpty:c,boundPartial:u}}(),w={MASS_ACTIONS:gettext("Mass actions"),RANGE_FROM:gettext("From"),RANGE_TO:gettext("To"),ITEMS_PER_PAGE:gettext("Items per page"),RESET_FILTERS:gettext("Reset filters"),RESET:gettext("Reset"),SORT_BY:gettext("Sort by"),SORT_ASC:gettext("ascending"),SORT_DESC:gettext("descending"),SORT_DEFAULT:gettext("Default sorting")},S=function(e){var t=[];return k.map(e||{},function(e,n){var r=null;r=""===n?e&&e.length?""+e:null:e?n:null,r&&t.push(r)}),t.join(" ")},_=function(t,n){this.ctrl=e.mount(t,{view:y,controller:x}),this.ctrl.setSource(n)};return _.lang=w,_}(window.m,window.localStorage);"undefined"!=typeof module&&null!==module&&module.exports?module.exports=Picotable:"function"==typeof define&&define.amd&&define(function(){return Picotable});
//# sourceMappingURL=picotable.js.map
