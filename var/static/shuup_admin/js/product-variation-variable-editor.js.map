{"version":3,"sources":["product-variation-variable-editor.js"],"names":["window","VariationVariableEditor","m","_","controller","this","showIdentifierFields","prop","config","el","variableSortableSetup","valueSortableSetup","refreshField","document","getElementById","value","JSON","stringify","variables","newPk","Math","random","getIdfrAndLanguagesCells","cellSelector","object","langKey","langLabelFormat","arguments","length","undefined","changeIdentifier","withAttr","identifier","changeXlate","code","map","languages","_ref","name","changeXlateP","partial","label","replace","placeholder","oninput","onchange","gettext","variableWrap","Sortable","create","group","handle","onEnd","event","reindex","oldIndex","newIndex","index","valuesTables","getElementsByClassName","forEach","call","itemId","item","getAttribute","currentVariable","currentValue","varIndex","valIndex","values","pk","sortingHandle","className","valueTr","ctrl","rowLabel","interpolate","data-id","href","onclick","DELETE","renderVariable","variable","deleteVariableButton","confirm","addValueButton","push","texts","preventDefault","nameRow","concat","bodyRows","reject","key","_ref2","view","variablesDiv","id","identifierFieldsCheckbox","type","checked","names","init","options","ctrlSingleton","mount","Array","prototype","splice"],"mappings":"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","file":"product-variation-variable-editor.js","sourcesContent":["/**\n * This file is part of Shuup.\n *\n * Copyright (c) 2012-2017, Shoop Commerce Ltd. All rights reserved.\n *\n * This source code is licensed under the OSL-3.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\nwindow.VariationVariableEditor = (function(m, _) {\n    \"use strict\";\n    var languages = null;\n    var variables = null;\n    var ctrlSingleton = null;\n\n    /**\n     * Adapted from https://www.npmjs.com/package/array.prototype.move\n     */\n    if(!Array.prototype.reindex) {\n        Array.prototype.reindex = function (oldIndex, newIndex) {\n            this.splice(newIndex, 0, this.splice(oldIndex, 1)[0]);\n        };\n    }\n\n    function controller() {\n        this.showIdentifierFields = m.prop(false);\n\n    }\n\n    function config(el) {\n        variableSortableSetup();\n        valueSortableSetup();\n    }\n\n    function refreshField() {\n        document.getElementById(\"id_variables-data\").value = JSON.stringify(variables);\n    }\n\n    function newPk() {\n        return \"$\" + Math.random();\n    }\n\n    function getIdfrAndLanguagesCells(cellSelector, object, langKey, langLabelFormat=\"$\", showIdentifierFields=true) {\n        const changeIdentifier = m.withAttr(\"value\", (value) => {\n            object.identifier = value; refreshField();\n        });\n        const changeXlate = (code, value) => {\n            object[langKey][code] = value; refreshField();\n        };\n        return [\n            _.map(languages, ({name, code}) => {\n                const changeXlateP = m.withAttr(\"value\", _.partial(changeXlate, code));\n                const label = langLabelFormat.replace(\"$\", name);\n                return m(cellSelector, [\n                    (label && label.length ? m(\"label\", label) : null),\n                    m(\"input.form-control\", {\n                        value: object[langKey][code] || \"\",\n                        placeholder: label,\n                        oninput: changeXlateP,\n                        onchange: changeXlateP\n                    })\n                ]);\n            }),\n            (showIdentifierFields ? m(cellSelector, [\n                m(\"input.form-control\", {\n                    value: object.identifier,\n                    placeholder: gettext(\"Identifier\"),\n                    oninput: changeIdentifier,\n                    onchange: changeIdentifier\n                })\n            ]) : null),\n        ];\n    }\n\n    /**\n     * Sets up Sortable on the variation variables\n     */\n    function variableSortableSetup() {\n        const variableWrap = document.getElementById(\"product-variable-wrap\");\n        Sortable.create(variableWrap, {\n          group: \"variable-sort\",\n          handle: \".variable-sort-handle\",\n          onEnd: function (event) {\n              variables.reindex(event.oldIndex, event.newIndex);\n              refreshField();\n          }\n        });\n    }\n\n    /**\n     * Sets up Sortable on the variation values\n     */\n    function valueSortableSetup(index) {\n        const valuesTables = document.getElementsByClassName('product-variable-values');\n        var index = 0;\n        [].forEach.call(valuesTables, function (el) {\n            Sortable.create(el, {\n                group: \"value-sort-\" + index,\n                handle: \".value-sort-handle\",\n                onEnd: function (event) {\n                    // The event.oldIndex is unreliable, it seems to be an\n                    // issue with nested sortables. The oldIndex is the one\n                    // from the parent sortable.\n                    const itemId = event.item.getAttribute('data-id');\n                    const newIndex = event.newIndex;\n                    var currentVariable = null;\n                    var currentValue = null;\n                    for(var varIndex=0; varIndex < variables.length; varIndex++) {\n                        currentVariable = variables[varIndex];\n                        for(var valIndex=0; valIndex < currentVariable.values.length; valIndex++) {\n                            currentValue = currentVariable.values[valIndex];\n                            if(currentValue.pk == itemId) {\n                                variables[varIndex].values.reindex(valIndex, newIndex);\n                            }\n                        }\n                    }\n                    refreshField();\n                }\n            });\n            index = index + 1;\n        });\n    }\n\n    /**\n     *  Return the sorting handle component\n     */\n    function sortingHandle(className) {\n        return m(\"i.fa.fa-bars.\" + className + \".pull-left\", \"\");\n    }\n\n    function valueTr(ctrl, value, index) {\n        const showIdentifierFields = ctrl.showIdentifierFields();\n        const rowLabel = interpolate(gettext(\"Value %s Name\"), [(index + 1)]);\n        return m(\"tr\", {'data-id': value.pk},\n            m(\"th\", [sortingHandle(\"value-sort-handle\"), rowLabel]),\n            getIdfrAndLanguagesCells(\"td\", value, \"texts\", \"\", showIdentifierFields),\n            m(\"td\", m(\"a.btn.text-danger.btn-xs\", {href: \"#\", onclick: () => {\n                value.DELETE = true;\n                refreshField();\n                return false;\n            }}, m(\"i.fa.fa-times-circle\"), \" \" + gettext(\"Delete value\")))\n        );\n    }\n\n    function renderVariable(ctrl, variable) {\n        const showIdentifierFields = ctrl.showIdentifierFields();\n        const deleteVariableButton = m(\"a.btn.btn-xs.text-danger\", {href: \"#\", onclick: () => {\n            if (variable.values.length === 0 || confirm(gettext(\"Are you sure?\"))) {\n                variable.DELETE = true;\n                refreshField();\n                return false;\n            }\n        }}, m(\"i.fa.fa-times-circle\"), \" \" + gettext(\"Delete Variable\"));\n        const addValueButton = m(\"a.btn.btn-xs.btn-text\", {href: \"#\", onclick: (event) => {\n            variable.values.push({pk: newPk(), identifier: \"\", texts: {}});\n            event.preventDefault();\n        }}, m(\"i.fa.fa-plus\"), \" \" + gettext(\"Add new value\"));\n        const nameRow = m(\"tr\", [m(\"th\", gettext(\"Variable Name\"))].concat(\n                getIdfrAndLanguagesCells(\"td\", variable, \"names\", \"\", showIdentifierFields)\n            ).concat([m(\"td\")])\n        );\n        const bodyRows = _.map(_.reject(variable.values, \"DELETE\"), _.partial(valueTr, ctrl));\n        return m(\"div.product-variable\", {key: variable.pk}, [\n            m(\"div.variable-heading.clearfix\", [\n                sortingHandle(\"variable-sort-handle\"),\n                m(\"h3.pull-left\", gettext(\"Variable\")),\n                m(\"div.pull-right\", deleteVariableButton)\n            ]),\n            m(\"div.variable-body\", [\n                m(\"div.table-responsive\", [\n                    m(\"table.table.table-bordered\", [\n                        m(\"thead\", [\n                            m(\"tr\", [m(\"th\")].concat(\n                                _.map(languages, ({name}) => m(\"th\", name))\n                            ).concat([\n                                showIdentifierFields ? m(\"th\", [\n                                    gettext(\"Identifer\")\n                                ]) : null,\n                                m(\"th\")\n                            ])),\n                        ]),\n                        m(\"tbody.product-variable-name\", nameRow),\n                        m(\"tbody.product-variable-values\", bodyRows)\n                    ])\n                ]),\n                m(\"div.new-row\", addValueButton)\n            ])\n        ]);\n    }\n\n    function view(ctrl) {\n        var variablesDiv = m(\n            \"div.product-variable-wrap\", {id: \"product-variable-wrap\"},\n            _.map(_.reject(variables, \"DELETE\"), _.partial(renderVariable, ctrl))\n        );\n        var identifierFieldsCheckbox = m(\"p\", [\n            m(\"label.small\", [\n                m(\"input\", {\n                    type: \"checkbox\",\n                    checked: !!ctrl.showIdentifierFields(),\n                    onclick: m.withAttr(\"checked\", ctrl.showIdentifierFields)\n                }),\n                \" \" + gettext(\"Show identifier fields (for advanced users)\")\n            ])\n        ]);\n        if (!variables.length) {\n            variablesDiv = m(\"p.text-info\", [\n                m(\"i.fa.fa-exclamation-circle\"), \" \" + gettext(\"There are no variables defined.\"),\n                m(\"hr\")\n            ]);\n            identifierFieldsCheckbox = null;\n        }\n        return m(\"div\", {config: config}, [\n            identifierFieldsCheckbox,\n            m(\"hr\"),\n            variablesDiv,\n            m(\"a.btn.btn-lg.btn-text\", {href: \"#\", onclick: (event) => {\n                variables.push({pk: newPk(), identifier: \"\", names: {}, values: []});\n                event.preventDefault();\n            }}, m(\"i.fa.fa-plus\"), \" \" + gettext(\"Add new variable\"))\n        ]);\n    }\n\n    function init(options) {\n        if (ctrlSingleton) {\n            return;\n        }\n        languages = options.languages;\n        variables = options.variables;\n        window.VariationVariableEditor.ctrl = ctrlSingleton = m.mount(\n            document.getElementById(\"variation-variable-editor\"),\n            {controller: controller, view: view}\n        );\n    }\n    return {init: init};\n}(window.m, window._));\n\n"],"sourceRoot":"/source/"}